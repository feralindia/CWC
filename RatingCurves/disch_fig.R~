## Import the results CSV file and plot the discharge-stage curve for each site
csv.flst <- list.files(path=csv.dr, pattern="_SD.txt$", ignore.case=TRUE, full.names=TRUE)
csv.flno <- list.files(path=csv.dr, pattern="_SD.txt$", ignore.case=TRUE, full.names=FALSE)
csv.flno <- substr(csv.flno, start=5, stop=(nchar(csv.flno)-7))
for (x in 1:length(csv.flst)){
    csv.file <- csv.flst[x]
    out.file <- paste(substr(csv.file, start=0, stop=(nchar(csv.file)-6)), "Stage_Discharge.csv", sep="")
    tmp <- read.csv(csv.file, header=FALSE, sep="\t")
    tmp <- tmp[complete.cases(tmp[, c(5,6)]),] ## remove rows with missing data in stage or discharge column
    names(tmp) <- c("Sl.No.", "site", "obs.file", "method", "stage", "avg.disch")
    wlr.no <- csv.flno[x]
    ## wlr.no <- unlist(regmatches(csv.file, gregexpr('\\(?[0-9]+a?', csv.file)))
    figfile <- paste(fig.dr, "/WLR_", wlr.no, ".png", sep="")
    mn <- paste("Stage Discharge Curve || Site: WLR_", wlr.no, sep="") # figure title
    ## postscript(figfile, horizontal=TRUE, onefile=TRUE) # dump to eps
    png(filename=figfile, width=640, height=480, units="px", pointsize=12, type="cairo") # dump to png
    plot(tmp$stage, tmp$avg.disch, xlab="Stage (m)", ylab="Discharge (m^3/s)", main=mn, type="p") # do the plot, note stage in m and discharge in m3/sec
    ## legend.names <- levels(tmp$method)
    ## legend('topright', legend.names ,  fill=c('red', 'blue', 'green',' brown'), bty='n', cex=.75)
    dev.off() # transfer data to file
    write.csv(tmp, file=out.file)
}
