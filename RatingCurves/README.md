# Rating Curves

This collection of scripts creates a rating or stage/discharge curve based on three kinds of datasets:

1. Area/velocity measures using a pygmy current meter and a stream profile.
2. Salt dilution gauging using:
   1. Slug method and
   2. Constant release method.
3. Float or orange method.

Of these, we found estimates from the float and constant release method to give highly varying results between repeats and this data has been ignored. Also, field notes were used to finally de-select point which were outliers. This process has been documented in the datasets.

Sequence of scripts:

	"site.R" -> "useful.functs.R" -> "managefiles.R" -> "libs.R" -> "ExtractStage.R" -> "disch_pyg_figs.R" -> "pyg.R" -> "flt.R" -> "AppendSDG.R" -> "fig.R"

TODO

- [] @rsbhalla, Add the [Slug.R](../Discharge/Slug.R) script to the sequence of processing.

## [site.R](disch_nlg.R)

This script sets the environment for the two sites; agh.R for Aghnashini and nlg.R for Nilgiris. It then calls the other routines and optionally cleans up the memory (code needs uncommenting).

TODO:

- [] Sub-routines require naming to be shifted to the site.R code.
- [] Rename scripts, remove "disch_" prefix.

## [useful.functs.R](useful.functs.R)

Functions used by the other routines to simplify procedures and reduce code size. Note, many code snippets are from <http://stackoverflow.com/> and other on-line resources. I've tried to attribute them but may have missed a few :grimacing:

### substrLeft/Right

Slight modification of the `substr` function allowing removal of "x" number of characters from a string.

### is.even/odd

Test to see if a numeric vector is even/odd.

### .ls.objects

From [this link](http://stackoverflow.com/questions/1358003/tricks-to-manage-the-available-memory-in-an-r-session), lists objects taking up most amount of memory. Used in conjunction with the `lsos` function which is shorthand for the `ls.objects` function. Follow link for more details.

### delfiles

Deletes the list of file names - works on the sub-folders of the `rating` directory.

### fixtime

Corrects goofs in date/time entries in the datasheets, specifically where time has been entered in the 24 hour format AND the AM/PM suffix is also used. Uses [this](http://stackoverflow.com/questions/2261079/how-to-trim-leading-and-trailing-whitespace-in-r) source for removing leading spaces.

### writeshape

Takes coordinates and file name to output a shapefile of the polygon representing the stream cross section. The output is to scale and allow the user to validate the area calculations via a GIS package such as Q-GIS.

TODO

- [] @rsbhalla, Consider adding function for importing and binding data files.
- [] @rsbhalla, Function for generating graphs to be added to cut down code in `fig.R`.
- [] @rsbhalla, Function for naming files/folders for input/output.

## [managefiles.R](disch_managefiles.R)

Defines the folder/file names for the following:

* Location of types of data folders for pygmy current meters, float method data, stream profile data for pygmy meters, stream profile data for float method, folder where manual profiles (after checking) are saved, folder to hold (ESRI) shape files of the profile to make it easier to do area calculations for cross checking. Finally, names associated with the pygmy current meters for data output.
* List of folders under data types. Covers pygmy meters and floats.
* List all files contained in the various directories.
* List folder names to be deleted for post-script cleanup.
* List missing files between the velocity measures and cross section.

TODO

- [] @rsbhalla, Add file naming for salt dilution gauging.

## [libs.R](disch_libs.R)

Load the various libraries required to run the script.

## [ExtractStage.R](disch_ExtractStage.R)

Extracts the stage for a water level recorder given the data and time of the stream profile and put in csv file and `R` object. Timestamps are read off the data sheets and matched with the outputs generated by the [WLR scripts.](../WLR/README.md)

## pyg.figs.R

This script is to be run only if the cross sectional profiles have not been manually checked. The script simply assists in deciding the size of each cross sectional region for successive velocity profiles. It draws both the cross section of the stream and the locations at which the velocity meters were placed.
![Example of figure output by the script](Docs/pyg_man.png)

Based on these drawings, the user needs to create a new file under the folder 'cx_sec/wlr_XX' folder.
An example of one such file (based on the figure above) is:

secno | start | end | file_name
----- | ----- | --- | ---------
1 | 0 | 90 | 29Sep2013.csv
2 | 90 | 147.6 | 29Sep2013.csv
3 | 147.6 | 205 | 29Sep2013.csv

### Chunk 1

For each station folder (i.e. wlr_XXX):

* Create dataframes to hold temporary and final results.
* List file names for the `cx_pyg` and `pyg` folder.
* Print message that the respective file is being processed.

### Chunk 2




## [pyg.R](disch_pyg.R)

This script processes the data for velocity area profiles, with velocity measurements by the pygmy current meters.

### Chunk 1

For each station folder (i.e. wlr_XXX):

* Print message with name of station being processed.
* Create dataframes to hold temporary as well as final results.

### Chunk 2

For each file contained in the station folder:

* Create lists of files from different types of folders. Note: the contents of file names in the velocity reading folder `pyg` must match those in the stream profile or cross section survey `cx_pyg`

### TODO

- [] @susan, Give details of model make.
- [] @saravanan. Provide data sheet and note on data organisation.
- [] @kumaran. Create EpiCollect based forms.
