## Needs to be updated with new directory structure
library(RPostgreSQL)
## Define the connection
con <- dbConnect(PostgreSQL(), user= "rsb", password="kar4nahi9", dbname="cwc");
## Read all CSV files but chop the first 10 lines which contain the headers

## tail -n +10 WLR104_104_001_31_05_2013.CSV > new.csv

wlrdatadir<-"/home/udumbu/rsb/OngoingProjects/CWC/Data/wlr/"
## Create tables to hold the wlr datasets
num_wlr<-101:104 # the number of wlr
## Ensure the diretories for the data are created
## in the console "mkdir wlr{101..104}" will create directories wlr_101 to wlr_104
i=1
while(i<=length(num_wlr)){
  ## This statement is to create a table for each wlr
  stm<-paste("CREATE TABLE IF NOT EXISTS nilgiris.wlr_", 
             num_wlr[i], "_raw(scan integer, date date, time time, wl_raw real, wl_cal real);", sep="")
  rs <- dbSendQuery(con, stm)
  rm(stm)
  ## This statement is to copy the data from the respective wlr folders into the tables.
  ## Note that only CSV files are supported - don't stick in xls sheets.
  ## List the names of the files
  wlrtab<-paste("wlr_", num_wlr[i], sep="") # Database table for storing wlr data.
  wlrtab_raw<-paste("wlr_", num_wlr[i], "_raw", sep="")
  wlrdir<-paste(wlrdatadir, wlrtab, sep="") # Directory holding all wlr sub folders
  dirliststm<-paste("ls ", wlrdir, sep="") # List contents of wlr## folder.
  filelist<-system(dirliststm, intern=TRUE) # Save the list of contents to an object
  ## run another loop within the earlier one
  ## This loop copies all the csv/dat files onto a raw wlr table
  ## In a departure from the earlier script, remove the first ten lines (header)
  ## First move to the relevant directory.
  setwd(wlrdir)
  ## First change the datestyle to dmy
  stm<-paste("SET datestyle = 'ISO, DMY';")
  rs<-dbSendQuery(con,stm)
  rm(stm)
  j=1
  while(j<=length(filelist)){
    rmhead<-paste("tail -n +13", filelist[j], " > tmp.csv")
    system(rmhead)
    stm<-paste("COPY nilgiris.wlr_", num_wlr[i], "_raw FROM '", 
               wlrdir, "/tmp.csv' DELIMITER ',' CSV;", sep="")
    rs<-dbSendQuery(con,stm)
    rm(stm)
    system("rm tmp.csv")
    j=j+1;
  }
  ## Reset the datestyle to default
  stm<-paste("SET datestyle = default;")
  rs<-dbSendQuery(con,stm)
  rm(stm)
  ## Create the tables to hold wlr data - one per wlr 
  stm<-paste("CREATE TABLE IF NOT EXISTS nilgiris.wlr_", 
             num_wlr[i], "(id SERIAL PRIMARY KEY, scan integer, date_time timestamp, 
             wl_raw real, wl_cal real);", sep="")
  rs <- dbSendQuery(con, stm)
  rm(stm)
  ## Now transfer the data from the raw table to the clean table.
  stm<-paste("INSERT INTO nilgiris.", wlrtab, "(scan, date_time, wl_raw, wl_cal) 
             SELECT DISTINCT nilgiris.", wlrtab_raw, ".scan, 
concat(nilgiris.", wlrtab_raw, ".date, ' ', nilgiris.", wlrtab_raw, ".time)::timestamp, 
             nilgiris.", wlrtab_raw, ".wl_raw,  nilgiris.", wlrtab_raw, ".wl_cal
             FROM nilgiris.", wlrtab_raw, " LEFT JOIN nilgiris.", wlrtab, "
             ON concat(nilgiris.", wlrtab_raw, ".date, ' ', nilgiris.", wlrtab_raw, ".time)::timestamp=", wlrtab, ".date_time
             AND nilgiris.", wlrtab_raw, ".scan=nilgiris.", wlrtab, ".scan
             WHERE ", wlrtab, ".date_time IS NULL AND ", wlrtab, ".scan IS NULL;", sep="")
  rs <- dbSendQuery(con, stm)
  rm(stm)
  ## Remove the raw raw tables or they'll grow continuously.
  stm<-paste("DROP TABLE nilgiris.", wlrtab_raw, ";", sep="")
  rs <- dbSendQuery(con, stm)
  rm(stm)
  ## VACUUM the tables to remove dead tuples
  stm<-paste("VACUUM nilgiris.", wlrtab, ";", sep="")
  rs <- dbSendQuery(con, stm)
  rm(stm)
  i=i+1;
}
## Close the connection
postgresqlCloseConnection(con)